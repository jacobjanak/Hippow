<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spots.cc</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reset-css@5.0.1/reset.min.css" />
    <link rel="stylesheet" href="/fontawesome/css/all.css" />
    <style>
        *, html, body {
            font-family: 'Courier New', Courier, monospace;
        }

        .fa-check-circle {
            color: green;
        }

        .fa-exclamation-circle {
            color: orange;
        }

        /* adjust the words next to a icon so that they're in line with other words */
        .adjust-left {
            padding-right: 3px;
        }

        #transactions-container {
            display: none; /* hidden until all transactions are loaded in */
            direction: rtl; /* move scrollbar to left side */
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            overflow-y: auto;
            max-width: 240px;
            background-color: antiquewhite;
        }

        /* hide scrollbar */
        /* #transactions-container::-webkit-scrollbar {
            display: none;
        } */

        #transactions-header {
            direction: ltr; /* move scrollbar to left side */
            padding: 16px 16px 8px;
            border-bottom: 1px black solid;
            text-align: center;
        }

        .transaction {
            direction: ltr; /* move scrollbar to left side */
            cursor: pointer;
            padding: 16px;
        }

        .transaction:hover, .transaction.active {
            background-color: bisque;
        }

        .transaction > .status {
            text-align: right;
            margin-bottom: 4px;
        }

        #balance-container {
            cursor: pointer;
            position: fixed;
            top: 16px;
            right: 32px;
            padding: 8px 16px;
            text-align: right;
            background-color: antiquewhite;
            border-radius: 16px;
            border: 1px black solid;
            /* transition: width 2s ease-out 100ms; */
        }

        #balance-container:hover {
            /* width: 300px;
            height: 200px; */
            background-color: bisque;
        }

        #wallet-info {
            margin-top: 16px;
            padding-left: 16px;
            padding-bottom: 16px;
            display: none;
        }

        #wallet-address {
            margin-bottom: 16px;
            font-size: small;
        }

        #send-container {
            display: flex;
            flex-direction: row;
            justify-content: center;
            margin-top: 64px;
        }

        h3 {
            margin-bottom: 32px;
            text-align: center;
            font-size: 1.5em;
        }

        #to {
            margin-bottom: 16px;
        }

        #fee {
            text-align: right;
            font-size: small;
            margin-top: 2px;
            margin-bottom: 8px;
        }

        input {
            width: 256px;
        }

        #send-button {
            cursor: pointer;
            margin-top: 8px;
            width: 100%;
        }

        #transaction-container {
            display: none;
            margin-top: 58px;
            padding-left: 252px;
        }

        .secret-info {
            margin-bottom: 16px;
            max-width: 768px;
        }

        .secret-info:last-of-type {
            margin-bottom: 32px;
        }

        #secret-form {
        }

        #result {
            margin-top: 4px;
            height: 32px;
        }

        #confirmed-container {
            margin-bottom: 8px;
        }

        #genesis-container {
            margin-bottom: 32px;
        }

        #image-container {
            margin-bottom: 32px;
        }

        /* #image-container {
            height: 450px;
            width: 600px;
        }

        img {
            max-height: 100%;
            max-width: 100%;
        } */
    </style>
</head>

<body>

    <div id="transactions-container">
        <div id="transactions-header">Blockchain</div>
    </div>

    <div id="balance-container">
        <!-- <div id="wallet-address"></div> -->
        <div>Wallet Balance</div>
        <div><span id="wallet-balance">0</span> Spots</div>
        <div id="wallet-info">
            <p>Public Address</p>
            <p id="wallet-address"></p>
            <p>Private Key</p>
            <p id="wallet-secret"></p>
        </div>
    </div>

    <div id="send-container">
        <form id="send-form">
            <h3>Send Spots</h3>
            <label for="to">Recipient Address</label><br />
            <input id="to" type="text" autocomplete="off" minlength="64" maxlength="64" required /><br />
            <label for="amount">Amount</label><br />
            <input id="amount" type="number" min="0" required /><br />
            <p id="fee">(Fee = 1 Spot)</p>
            <button id="send-button">Send</button>
        </form>
    </div>

    <div id="transaction-container">
        <form id="secret-form">
            <p class="secret-info">This transaction is still pending. To confirm this transaction, be the first to guess the secret word by spotting something in the image below. You have unlimited guesses and it is not case-sensitive.</p>
            <p class="secret-info">You will recieve 1 Spot for confirming this transaction.</p>
            <label for="secret">Guess the secret word</label><br />
            <input id="secret" type="text" autocomplete="off" required />
            <button>Submit</button>
            <p id="result"></p>
        </form>
        <div id="confirmed-container">
            <p>Transaction confirmed.</p>
            <p>Secret: <span id="secret-reveal"></span></p>
        </div>
        <div id="genesis-container">
            <p>This is the genesis block.</p>
        </div>
        <div id="image-container"></div>
        <div id="transaction-info-container">
            <!-- <div>Transaction Hash: <span id="transaction-hash"></span></div>
            <div>From: <span id="transaction-from"></span></div>
            <div>To: <span id="transaction-to"></span></div>
            <div>Amount: <span id="transaction-amount"></span> Spots</div> -->
        </div>
    </div>

    <script
        src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
        crossorigin="anonymous"></script>
    <script src="/sha256.js"></script>
    <script src="/fontawesome/js/all.js"></script>

    <script>

        // track current transaction user is viewing
        let currentBlockIndex;
        let currentBlock;
        let currentDataURI;

        let wallet = {
            address: localStorage.getItem("walletAddress"),
            balance: 0,
        };

        function makeSecret() {
            var result = "";
            var characters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            var charactersLength = characters.length;
            for (let i = 0; i < 24; i++ ) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
        }

        if (!wallet.address) {
            wallet.secret = makeSecret();
            wallet.address = sha256(wallet.secret);
            localStorage.setItem("walletSecret", wallet.secret)
            localStorage.setItem("walletAddress", wallet.address)
        } else {
            wallet.secret = localStorage.getItem("walletSecret");
        }

        $("#wallet-address").text(wallet.address)
        $("#wallet-secret").text(wallet.secret.replace(/[^\dA-Z]/g, '').replace(/(.{4})/g, '$1 ').trim())

        let blockchain = [];
        $.get("/api/blockchain")
        .done(data => {
            blockchain = data;
            console.log(blockchain)
            for (let i = blockchain.length - 1; i >= 0; i--) {
                const block = blockchain[i];

                if (block.to === wallet.address) {
                    wallet.balance += parseInt(block.amount);
                }
                if (block.from === wallet.address) {
                    wallet.balance -= parseInt(block.amount) + 1;
                }
                if (block.image) {
                    if (block.image.spotter === wallet.address) wallet.balance += 1;
                }

                $("#transactions-container").append(`
                    <div class="transaction" data-index=${i}>
                        <div class="status ${block.image.secret ? "confirmed" : "pending"}">
                            ${block.image.secret
                                ? '<span class="adjust-left">Confirmed</span> <i class="fas fa-check-circle"></i>'
                                : '<span class="adjust-left">Pending</span> <i class="fas fa-exclamation-circle"></i>'}
                        </div>
                        <div class="hash">${block.hash.substring(0, 16)}...</div>
                        ${i > 0 ? `<div class="from">From: &nbsp;${block.from.substring(0, 9)}...</div>` : ''}
                        
                        <div class="to">To: &nbsp;&nbsp;&nbsp;${block.to.substring(0, 9)}...</div>
                        <div class="amount">Spots: ${block.amount}</div>
                    </div>
                `)
            }

            // $("#wallet-address").text(wallet.address.substring(0, 12) + "..")
            $("#wallet-balance").text(wallet.balance)
            $("#amount").attr("max", wallet.balance)
            $("#transactions-container").show()
            attachTransactionClickHandler()
        })

        $("#send-form").on("submit", e => {
            e.preventDefault()
            const to = $("#to").val().trim();
            const amount = parseInt($("#amount").val());

            if (amount > 0) {

                // send data to server
                // to do: add signature
                $.post("/api/transaction", {
                    from: wallet.address,
                    to: to,
                    amount: amount,
                })
                .done(data => { window.location.reload() })
                .fail(() => alert("error"))
            }
        })

        $("#secret-form").on("submit", e => {
            e.preventDefault()
            $("#result").text("")
            const guess = $("#secret").val().trim().toLowerCase();
            $("#secret").val("")

            const testHash = sha256(guess + currentDataURI);
            if (testHash === currentBlock.image.hash) {
                console.log(guess)
                $.post("/spot", {
                    secret: guess,
                    blockIndex: currentBlockIndex,
                    wallet: wallet.address,
                })
                .done(data => {
                    $("#result").text("Correct! Reloading...")
                    $("#result").css({ color: "green" })

                    // temp
                    setTimeout(() => {
                        window.location.reload()
                    }, 2000)
                })
                .fail(() => alert("error"))
            } else {
                $("#result").text("Incorrect guess")
                $("#result").css({ color: "red" })
            }
        })

        function attachTransactionClickHandler() {
            $(".transaction").on("click", function (e) {
                $(".transaction").removeClass("active")
                $(this).addClass("active")

                currentBlockIndex = parseInt($(this).attr("data-index"));
                // const block = blockchain[currentBlockIndex];
                currentBlock = blockchain[currentBlockIndex];

                // $("#transaction-hash").text(block.hash)
                // $("#transaction-from").text(block.from)
                // $("#transaction-to").text(block.to)
                // $("#transaction-amount").text(block.amount)

                let altered = false;
                if (!currentBlock.image.secret) {
                    currentBlock.image.secret = "???";
                    altered = true;
                }
                delete currentBlock.image.blockIndex; // just doing this because its useless
                const transactionInfo = JSON.stringify(currentBlock, null, 4).replace(/"|,/g, '');
                if (altered) delete currentBlock.image.secret;
                const formatted = `<pre><code>Transaction Details\n${transactionInfo}</code></pre>`;
                $("#transaction-info-container").html(formatted)

                if (currentBlockIndex === 0) {
                    $("#genesis-container").show()
                    $("#secret-form").hide()
                    $("#confirmed-container").hide()
                } else {
                    $("#genesis-container").hide()
                    if (currentBlock.image.secret) {
                        $("#secret-form").hide()
                        $("#secret-reveal").text(currentBlock.image.secret)
                        $("#confirmed-container").show()
                    }
                    else {
                        $("#result").text("")
                        $("#secret-form").show()
                        $("#confirmed-container").hide()
                    }
                }

                if (currentBlockIndex > 0) {
                    $.get("/image/" + currentBlock.image.index, dataURI => {
                        currentDataURI = dataURI;
                        const $img = $("<img>");
                        $img.attr("src", dataURI)
                        $("#send-container").hide()
                        $("#transaction-container").show()
                        $("#image-container").show()
                        $("#image-container").html($img)

                    })
                } else {
                    $("#send-container").hide()
                    $("#transaction-container").show()
                    $("#image-container").hide()
                }
                
            })
        }

        $("#balance-container").on("mouseenter", function(e) {
            // $(this).append(`<p>Address</p><p>${wallet.address}</p>`)
            $("#wallet-info").show()
        })

        $("#balance-container").on("mouseleave", function(e) {
            // $(this).append(`<p>Address</p><p>${wallet.address}</p>`)
            $("#wallet-info").hide()
        })
        
    </script>
    
</body>

</html>