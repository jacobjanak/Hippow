<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spots.cc</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reset-css@5.0.1/reset.min.css" />
    <link rel="stylesheet" href="/fontawesome/css/all.css" />
    <style>
        *, html, body {
            font-family: 'Courier New', Courier, monospace;
        }

        .fa-check-circle {
            color: green;
        }

        .fa-exclamation-circle {
            color: orange;
        }

        /* adjust the words next to a icon so that they're in line with other words */
        .adjust-left {
            padding-right: 3px;
        }

        #transactions-container {
            display: none; /* hidden until all transactions are loaded in */
            direction: rtl; /* move scrollbar to left side */
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            overflow-y: auto;
            max-width: 240px;
            background-color: antiquewhite;
        }

        /* hide scrollbar */
        /* #transactions-container::-webkit-scrollbar {
            display: none;
        } */

        #transactions-header {
            direction: ltr; /* move scrollbar to left side */
            padding: 16px 16px 8px;
            border-bottom: 1px black solid;
            text-align: center;
        }

        .transaction {
            direction: ltr; /* move scrollbar to left side */
            cursor: pointer;
            padding: 16px;
        }

        .transaction:hover {
            background-color: bisque;
        }

        .transaction > .status {
            text-align: right;
            margin-bottom: 4px;
        }

        #balance-container {
            cursor: pointer;
            position: fixed;
            top: 16px;
            right: 32px;
            padding: 8px 16px;
            text-align: right;
            background-color: antiquewhite;
            border-radius: 16px;
            border: 1px black solid;
        }

        #balance-container:hover {
            background-color: bisque;
        }

        #form-container {
            display: flex;
            flex-direction: row;
            justify-content: center;
            margin-top: 64px;
        }

        h3 {
            margin-bottom: 32px;
            text-align: center;
            font-size: 1.5em;
        }

        input {
            margin-bottom: 16px;
            width: 256px;
        }

        #send-button {
            cursor: pointer;
            margin-top: 8px;
            width: 100%;
        }

        #transaction-container {
            display: none;
            margin-top: 58px;
            padding-left: 252px;
        }

        .secret-info {
            margin-bottom: 16px;
            max-width: 768px;
        }

        .secret-info:last-of-type {
            margin-bottom: 32px;
        }

        #secret-form {
            margin-bottom: 8px;
        }

        #image-container {
            margin-bottom: 32px;
        }

        /* #image-container {
            height: 450px;
            width: 600px;
        }

        img {
            max-height: 100%;
            max-width: 100%;
        } */
    </style>
</head>

<body>

    <div id="transactions-container">
        <div id="transactions-header">Blockchain</div>
    </div>

    <div id="balance-container">
        <!-- <div id="wallet-address"></div> -->
        <div>Wallet Balance</div>
        <div><span id="wallet-balance">0</span> Spots</div>
    </div>

    <div id="form-container">
        <form id="send-form">
            <h3>Send Spots</h3>
            <label for="to">Recipient Address</label><br />
            <input id="to" type="text" autocomplete="off" required /><br />
            <label for="amount">Amount</label><br />
            <input id="amount" type="number" min="0" required /><br />
            <button id="send-button">Send</button>
        </form>
    </div>

    <div id="transaction-container">
        <form id="secret-form">
            <p class="secret-info">This transaction is still pending. To confirm the transaction, be the first to guess the secret word based on the image below. You have unlimited guesses and it is not case-sensitive.</p>
            <p class="secret-info">You will recieve 1 Spot for confirming the transaction.</p>
            <label for="secret">Guess the secret word</label><br />
            <input id="secret" type="text" />
            <button>Submit</button>
        </form>
        <div id="image-container"></div>
        <div id="transaction-info-container">
            <!-- <div>Transaction Hash: <span id="transaction-hash"></span></div>
            <div>From: <span id="transaction-from"></span></div>
            <div>To: <span id="transaction-to"></span></div>
            <div>Amount: <span id="transaction-amount"></span> Spots</div> -->
        </div>
    </div>

    <script
        src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
        crossorigin="anonymous"></script>
    <script src="/sha256.js"></script>
    <script src="/fontawesome/js/all.js"></script>

    <script>
        let wallet = {
            address: localStorage.getItem("walletAddress"),
            balance: 0,
        };

        if (!wallet.address) {
            wallet.address = sha256("" + Math.random());
            localStorage.setItem("walletAddress", wallet.address)
        } else {
            console.log("address: " + wallet.address)
        }

        let blockchain = [];
        $.get("/api/blockchain")
        .done(data => {
            blockchain = data;
            for (let i = blockchain.length - 1; i >= 0; i--) {
                const block = blockchain[i];

                if (block.to === wallet.address) wallet.balance += parseInt(block.amount);
                if (block.from === wallet.address) wallet.balance -= parseInt(block.amount);

                $("#transactions-container").append(`
                    <div class="transaction" data-index=${i}>
                        <div class="status ${block.image.secret ? "confirmed" : "pending"}">
                            ${block.image.secret
                                ? '<span class="adjust-left">Confirmed</span> <i class="fas fa-check-circle"></i>'
                                : '<span class="adjust-left">Pending</span> <i class="fas fa-exclamation-circle"></i>'}
                        </div>
                        <div class="hash">${block.hash.substring(0, 16)}...</div>
                        ${i > 0 ? `<div class="from">From: &nbsp;${block.from.substring(0, 9)}...</div>` : ''}
                        
                        <div class="to">To: &nbsp;&nbsp;&nbsp;${block.to.substring(0, 9)}...</div>
                        <div class="amount">Spots: ${block.amount}</div>
                    </div>
                `)
            }

            // $("#wallet-address").text(wallet.address.substring(0, 12) + "..")
            $("#wallet-balance").text(wallet.balance)
            $("#amount").attr("max", wallet.balance)
            $("#transactions-container").show()
            attachTransactionClickHandler()
        })

        $("#send-form").on("submit", e => {
            e.preventDefault()
            const to = $("#to").val();
            const amount = parseInt($("#amount").val());

            if (amount > 0) {

                // send data to server
                // to do: add signature
                $.post("/api/transaction", {
                    from: wallet.address,
                    to: sha256("" + Math.random()),
                    amount: amount,
                })
                .done(data => console.log(data))
                .fail(() => alert("error"))
            }
        })

        function attachTransactionClickHandler() {
            $(".transaction").on("click", function (e) {
                const blockIndex = parseInt($(this).attr("data-index"));
                const block = blockchain[blockIndex];

                // $("#transaction-hash").text(block.hash)
                // $("#transaction-from").text(block.from)
                // $("#transaction-to").text(block.to)
                // $("#transaction-amount").text(block.amount)

                let altered = false;
                if (!block.image.secret) {
                    block.image.secret = "???";
                    altered = true;
                }
                const transactionInfo = JSON.stringify(block, null, 4).replace(/"|,/g, '');
                if (altered) delete block.image.secret;
                const formatted = `<pre><code>Transaction Details\n${transactionInfo}</code></pre>`;
                $("#transaction-info-container").html(formatted)

                if (block.image.secret) $("#secret-form").hide();
                else $("#secret-form").show();

                if (blockIndex > 0) {
                    $.get("/image/" + (blockIndex - 1), dataURI => {
                        const $img = $("<img>");
                        $img.attr("src", dataURI)
                        $("#form-container").hide()
                        $("#transaction-container").show()
                        $("#image-container").show()
                        $("#image-container").html($img)

                    })
                } else {
                    $("#form-container").hide()
                    $("#transaction-container").show()
                    $("#image-container").hide()
                }
                
            })
        }
        
    </script>
    
</body>

</html>